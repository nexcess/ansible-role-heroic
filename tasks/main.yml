---

- name: Install Java + Deps
  package:
    state=latest
    name={{ item }}
  with_items: "{{ heroic_java_packages }}"

- name: Ensure Group Exists
  group:
    name={{ heroic_group }}
    state=present

- name: Ensure User Exists
  user:
    user={{ heroic_user }}
    group={{ heroic_group }}
    home={{ heroic_home }}
    state=present

- name: Get Heroic
  git:
    repo={{ heroic_git_repo }}
    dest={{ heroic_app_home }}
    version={{ heroic_git_branch }}
  args:
    creates={{ heroic_app_home }}

- name: Tighten Up Ownership
  file:
    path={{ heroic_home }}
    owner={{ heroic_user }}
    group={{ heroic_group }}
    recurse=yes

- name: Build Heroic's Repackaged JARs
  command: ./tools/install-repackaged
    chdir={{ heroic_app_home }}
    creates={{ heroic_app_home }}/repackaged/bigtable/target/bigtable-client-core-*.jar
  become: yes
  become_user: "{{ heroic_user }}"

- name: Build Heroic
  command: mvn clean package -D maven.test.skip=true
    chdir={{ heroic_app_home }}
    creates={{ heroic_app_home }}/heroic-dist/target/heroic-dist-0.0.1-SNAPSHOT-shaded.jar
  become: yes
  become_user: "{{ heroic_user }}"

- name: Install Heroic Config
  template:
    src=heroic.yml.j2
    dest={{ heroic_app_home }}/heroic.yml
    owner={{ heroic_user }}
    group={{ heroic_group }}
    mode=0600

- name: Configure Cassandra Keyspace
  command: echo -e "exit\n" | tools/heroic-shell -P cassandra -X cassandra.seeds=10.132.48.56,10.132.54.91,10.132.74.100 -X datastax.configure
    chdir={{ heroic_app_home }}
  become: yes
  become_user: "{{ heroic_user }}"

- name: Configure Elasticsearch Metadata
  command: echo -e "exit\n" | tools/heroic-shell -P elasticsearch-metadata
    chdir={{ heroic_app_home }}
  become: yes
  become_user: "{{ heroic_user }}"

- name: Configure Elasticsearch Suggest
  command: echo -e "exit\n" | tools/heroic-shell -P elasticsearch-suggest
    chdir={{ heroic_app_home }}
  become: yes
  become_user: "{{ heroic_user }}"

- name: Configure Collectd Endpoint
  command: echo -e "exit\n" | tools/heroic-shell -P collectd
    chdir={{ heroic_app_home }}
  become: yes
  become_user: "{{ heroic_user }}"

- name: Install Heroic Control Script
  template:
    src=heroic.j2
    dest={{ heroic_app_home }}/heroic
    owner={{ heroic_user }}
    group={{ heroic_group }}
    mode=0700

#- name: Install Heroic Systemd Script
#  template:
#    src=heroic.j2
#    dest={{ heroic_app_home }}/heroic
#    owner={{ heroic_user }}
#    group={{ heroic_group }}
#    mode=0700

#- name: Start Heroic
#  service:
#    name=heroic
#    state=started
